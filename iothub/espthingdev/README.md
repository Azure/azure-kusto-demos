# Exploring IOT devices events using Azure Data Explorer

Azure Data Explorer (ADX) connetion to Azure IotHub enables querying the data that is being generated by IOT devices. <br/>
This demo is an example of a system which contains a physical sensing device, Azure IotHub and ADX cluster. <br/>
This project is heavily based on this [Azure Sample](https://github.com/Azure-Samples/iot-hub-c-thingdev-getstartedkit) by Hector Garcia Tellado 

## Prerequisites

1. Azure subscription [Create new](https://azure.microsoft.com/en-us/free/search/?&OCID=AID719811_SEM_2hewkcJY&lnkd=Google_Azure_Brand&dclid=CK3H2Prg2eACFYOnUQodSVMBeQ)
2. Arduino IDE [Install](https://www.arduino.cc/en/Main/Software)
3. Hardware: 
    * ESP8266 Thing dev
    * HC-SR04 Ultrasonic sensor
    * DHT22 Temprature and Humidity sensor

### Hardware preparation 
Assemble the sensing device by wiring the sensors to the ESP microcontroller as follows:
![wiring](https://github.com/Azure/azure-kusto-demos/blob/master/iothub/espthingdev/wiring.PNG)

### Arduino IDE 
Add ESP8266 boards to the Arduino IDE by:<br/>
    1. In File->Preferences->Additional Boards Manager URLs add: http://arduino.esp8266.com/stable/package_esp8266com_index.json<br/>
    2. In Tools->Board->Boards Manager Install esp8266 by ESP8266 Community **version 2.4.0**<br/>
Add the following libraries in Sketch->Include Library->Manage Libraries:<br/>
    * AzureIoTHub by Microsoft<br/>
    * AzureIoTProtocol_MQTT by Microsoft<br/>
    * AzureIoTUtility by Microsoft<br/>
    * Adafruit Unified Sensor by Adafruit<br/>
    * DHT Sensor Library by Adafruit
    
### IotHub
Create an IotHub Instance and register a device as described in this [Quickstart](https://docs.microsoft.com/en-us/azure/iot-hub/quickstart-send-telemetry-c)
Save the device connection string to use in the device firmware: 
    In 'espthingdev.ino' edit the following lines:
    `const char ssid[] = ""; //  your WiFi SSID (name)`
    `const char pass[] = "";    // your WiFi password (use for WPA, or use as key for WEP)`
    `const char connectionString[] = ""; // iot hub connectionString`
    
### Azure Data Explorer
Create an ADX cluster and database as described in this [Quickstart](https://docs.microsoft.com/en-us/azure/data-explorer/create-cluster-database-portal)

* Create table:

`.create table EspThingEvents (DeviceId:string,EventTime: int, Temperature:double,Humidity:double, Distance:long)`

* Add table mapping:

`.create table EspThingEvents ingestion json mapping "EspThingEventsMapping" '[`<br/>
`    {"column":"DeviceId","path":"$.DeviceId"},`<br/>
`    {"column":"EventTime","path":"$.EventTime"},`<br/>
`    {"column":"Temperature","path":"$.Temperature"},`<br/>
`    {"column":"Humidity","path":"$.Humidity"},`<br/>
`    {"column":"Distance","path":"$.Distance"}]'`

* Add IotHub ingestion source:

`.add dm service <DM cluster name> eventhub ingestion source IoThubIngestionSource with(`<br/>
    `IngestionSourceType='IotHub',`<br/>
    `EventHubResourceId='<IotHub Resource ID - can be found at the IotHub properties>',`<br/>
    `EventHubNamespaceConnectionString='<IotHub Endpoint - can be found at IotHub Built-in endpoints>', `<br/>
    `EventHubName='', `<br/>
    `EventHubConsumerGroupName='$Default',` <br/>
    `PartitionCount='4',`<br/>
    `TargetDatabase='<ADX target database>',`<br/>
    `TargetTable='EspThingEvents',`<br/>
    `Format='json',`<br/>
    `IngestionMappingReference='EspThingEventsMapping'`  <br/>
`)`
    
# Contributing

This project welcomes contributions and suggestions.  Most contributions require you to agree to a
Contributor License Agreement (CLA) declaring that you have the right to, and actually do, grant us
the rights to use your contribution. For details, visit https://cla.microsoft.com.

When you submit a pull request, a CLA-bot will automatically determine whether you need to provide
a CLA and decorate the PR appropriately (e.g., label, comment). Simply follow the instructions
provided by the bot. You will only need to do this once across all repos using our CLA.

This project has adopted the [Microsoft Open Source Code of Conduct](https://opensource.microsoft.com/codeofconduct/).
For more information see the [Code of Conduct FAQ](https://opensource.microsoft.com/codeofconduct/faq/) or
contact [opencode@microsoft.com](mailto:opencode@microsoft.com) with any additional questions or comments.
